var G=Global;var Providers=({_provider:{redirect_uri:G.providers._default.redirect_uri,storage:window.localStorage||window.sessionStorage,flags:{without_childBrowser:undefined},md5:function(a){return hex_md5(a)},saveToken:function(b){var a=this;a.storage.setItem(a.name+"_token",JSON.stringify(b))},loadToken:function(){var a=this;var b=a.storage.getItem(a.name+"_token");if(b!==null){b=JSON.parse(b)}return b},removeToken:function(){var a=this;var b=a.storage.getItem(a.name+"_token");if(b!==null){a.storage.removeItem(a.name+"_token")}},getTokenLink:function(){return""},getProfileDataLink:function(){return""},authorize:function(c){var b=this;b.flags.without_childBrowser=c;var a=b.loadToken();if(a===null&&b.flags.without_childBrowser){b.onTokenError();return}else{if(a){b.onToken(a);return}}b.getToken()},getToken:function(){var b=this;var a=window.open("http://mobile.afisha-uu.ru/loading.html?"+b.getTokenLink(),"_blank","location=yes");a.addEventListener("loadstop",function(e){var d=e.url;if(d.indexOf(b.redirect_uri)==0){var c=d.getParamsFromUrl();a.close();c.error?b.onError(c.error):b.onToken(c,true)}})},getProfileData:function(){var b=this;var a=new XMLHttpRequest();a.onreadystatechange=function(){if(a.readyState==4){var c=JSON.parse(a.responseText);(a.status==200&&c.error==undefined)?b.onProfileData(b.formatProfileData(c)):b.onTokenError()}};a.open("GET",b.getProfileDataLink(),true);a.send(null)},formatProfileData:function(b){var a=this;return b},logout:function(){var a=this;a.removeToken()},onTokenError:function(){var a=this;a.removeToken();if(a.flags.without_childBrowser){a.onError("token error");return}a.getToken()},onError:function(a){},onToken:function(d,a){var c=this;c.saveToken(d);a?c.flags.without_childBrowser=true:"";for(var b in d){c[b]=d[b]}c.getProfileData()},onProfileData:function(b){var a=this;a.onSuccess(b)},onSuccess:function(a){}},_list:[{name:"vkontakte",redirect_uri:"http://oauth.vk.com/blank.html",icon:"config/resources/icons/social/iko_1.png",url:"http://vkontakte.ru/",app_id:G.providers.vk.app_id,getTokenLink:function(){var a=this;return"http://oauth.vkontakte.ru/authorize?client_id="+a.app_id+"&scope=offline,wall&redirect_uri=blank.html&display=touch&response_type=token"},getProfileDataLink:function(){var a=this;return"https://api.vkontakte.ru/method/getProfiles?uid="+a.user_id+"&fields=sex,bdate,city,nickname,photo_big&access_token="+a.access_token},formatProfileData:function(b){var a=this;b=b.response[0];b={identity:a.url+"id"+b.uid,provider:a.url,prov_name:a.name,first_name:b.first_name,last_name:b.last_name,full_name:b.first_name+" "+b.last_name,nickname:b.nickname,photo:b.photo_big,uid:b.uid,dob:b.bdate,gender:b.sex==2?"М":(b.sex==1?"Ж":""),email:undefined};return b},sendPost:function(a,e,d,f){var c=this;var e="https://api.vkontakte.ru/method/wall.post?uid="+c.user_id+"&message="+a+"&attachments="+e+"&access_token="+c.access_token;var b=new XMLHttpRequest();b.onreadystatechange=function(){if(b.readyState==4){var g=JSON.parse(b.responseText);(b.status==200&&g.error==undefined)?f.call(d,"ok"):f.call(d,"error")}};b.open("GET",e,true);b.send(null)}},{name:"google",icon:"config/resources/icons/social/iko_3.png",url:"http://google.com/",client_id:G.providers.google.client_id,redirect_uri:"http://localhost",getTokenLink:function(){var a=this;return"https://accounts.google.com/o/oauth2/auth?client_id="+a.client_id+"&scope=https://www.googleapis.com/auth/userinfo.email+https://www.googleapis.com/auth/userinfo.profile&redirect_uri="+a.redirect_uri+"&response_type=token"},getProfileDataLink:function(){var a=this;return"https://www.googleapis.com/oauth2/v1/userinfo?access_token="+a.access_token},formatProfileData:function(b){var a=this;b={identity:b.link,provider:a.url,prov_name:a.name,first_name:b.given_name,last_name:b.family_name,full_name:b.name,nickname:undefined,photo:b.picture,uid:b.id,dob:undefined,gender:b.sex=="male"?"М":(b.sex=="female"?"Ж":""),email:b.email};return b},},{name:"facebook",icon:"config/resources/icons/social/iko_2.png",url:"http://facebook.com/",app_id:G.providers.fb.app_id,getTokenLink:function(){var a=this;return"https://www.facebook.com/dialog/oauth?client_id="+this.app_id+"&scope=publish_stream&redirect_uri="+this.redirect_uri+"&display=touch&response_type=token"},getProfileDataLink:function(){var a=this;return"https://graph.facebook.com/me?access_token="+this.access_token},formatProfileData:function(b){var a=this;b={identity:b.link,provider:a.url,prov_name:a.name,first_name:b.first_name,last_name:b.last_name,full_name:b.name,nickname:b.username,photo:"https://graph.facebook.com/"+b.id+"/picture",uid:b.id,dob:b.birthday,gender:b.sex=="male"?"М":(b.sex=="female"?"Ж":""),email:b.email};return b},sendPost:function(a,e,d,f){var c=this;var e="https://graph.facebook.com/me/feed?access_token="+this.access_token+"&message="+a+"&link="+e;var b=new XMLHttpRequest();b.onreadystatechange=function(){if(b.readyState==4){var g=JSON.parse(b.responseText);(b.status==200&&g.error==undefined)?f.call(d,"ok"):f.call(d,"error")}};b.open("POST",e,true);b.send(null)}},{name:"odnoklassniki",icon:"config/resources/icons/social/iko_5.png",url:"http://odnoklassniki.ru/",app_id:G.providers.odnoklassniki.app_id,secret_key:G.providers.odnoklassniki.secret_key,public_key:G.providers.odnoklassniki.public_key,getProfileDataLink:function(){var c=this;var d={application_key:c.public_key,};var a="";for(var b in d){a+=b+"="+d[b]}return"http://api.odnoklassniki.ru/api/users/getCurrentUser?application_key="+c.public_key+"&access_token="+c.access_token+"&sig="+c.md5(a+c.md5(c.access_token+c.secret_key))},getTokenLink:function(){var a=this;return"http://odnoklassniki.ru/oauth/authorize?client_id="+a.app_id+"&scope=VALUABLE ACCESS&redirect_uri="+a.redirect_uri+"&response_type=code"},formatProfileData:function(b){var a=this;b={identity:a.url+"profile/"+b.uid,provider:a.url,prov_name:a.name,first_name:b.first_name,last_name:b.last_name,full_name:b.name,nickname:undefined,photo:b.pic_2,uid:b.uid,dob:b.birthday,gender:b.sex=="male"?"М":(b.sex=="female"?"Ж":""),email:undefined};return b},_getTokenLink:function(b){var a=this;return"http://api.odnoklassniki.ru/oauth/token.do?client_id="+a.app_id+"&code="+b.code+"&redirect_uri="+a.redirect_uri+"&grant_type=authorization_code&client_secret="+a.secret_key},onToken:function(d,a){var c=this;if(!a){c.__proto__.onToken.call(c,d);return}var c=this;var b=new XMLHttpRequest();b.onreadystatechange=function(){if(b.readyState==4){var e=JSON.parse(b.responseText);(b.status==200&&e.error==undefined)?c.__proto__.onToken.call(c,e):c.onTokenError()}};b.open("POST",c._getTokenLink(d),true);b.send(null)},},{name:"mail.ru",icon:"config/resources/icons/social/iko_6.png",url:"http://mail.ru/",app_id:G.providers.odnoklassniki.app_id,secret_key:G.providers.odnoklassniki.secret_key,getTokenLink:function(){var a=this;return"https://connect.mail.ru/oauth/authorize?client_id="+a.app_id+"&redirect_uri="+a.redirect_uri+"&response_type=token&display=mobile"},getProfileDataLink:function(){var c=this;var d={app_id:c.app_id,method:"users.getInfo",secure:1,session_key:c.access_token};var a="";for(var b in d){a+=b+"="+d[b]}return"http://www.appsmail.ru/platform/api?app_id="+c.app_id+"&method=users.getInfo&secure="+1+"&session_key="+c.access_token+"&sig="+c.md5(a+c.secret_key)},formatProfileData:function(b){var a=this;b=b[0];b={identity:b.link,provider:a.url,prov_name:a.name,first_name:b.first_name,last_name:b.last_name,full_name:b.first_name+" "+b.last_name,nickname:b.nick,photo:b.pic,uid:b.uid,dob:b.birthday,gender:b.sex==0?"М":(b.sex==1?"Ж":""),email:undefined};return b},},{name:"twitter",url:"http://twitter.com/",icon:"config/resources/icons/social/iko_4.png",consumer_key:G.providers.twitter.consumer_key,consumer_secret:G.providers.twitter.consumer_secret,getToken:function(){var a=this;a.oauth=OAuth(a.getTokenParams());a.oauth.get("https://api.twitter.com/oauth/request_token",function(b){b=b.text;b=b.getParamsFromUrl();b.error?a.onError("token error"):(function(){for(var c in b){a[c]=b[c]}a.__proto__.getToken.call(a)})()},function(){a.onError("token error")})},getTokenParams:function(){var a=this;return{consumerKey:a.consumer_key,consumerSecret:a.consumer_secret,callbackUrl:a.redirect_uri}},getAccessTokenParams:function(){var a=this;return{consumerKey:this.consumer_key,accessTokenKey:this.oauth_token,accessTokenSecret:this.oauth_token_secret,consumerSecret:this.consumer_secret,callbackUrl:this.redirect_uri}},getTokenLink:function(){var a=this;return"http://api.twitter.com/oauth/authorize?oauth_token="+a.oauth_token},getAccessTokenLink:function(){var a=this;return"https://api.twitter.com/oauth/access_token?oauth_verifier="+a.oauth_verifier+"&oauth_token="+a.oauth_token+"&oauth_token_secret="+a.oauth_token_secret},getProfileDataLink:function(){var a=this;return"https://api.twitter.com/1/account/verify_credentials.json"},formatProfileData:function(b){var a=this;b={identity:a.url+b.screen_name,provider:a.url,prov_name:a.name,first_name:undefined,last_name:undefined,full_name:b.name,nickname:b.screen_name,photo:b.profile_image_url,uid:b.id,dob:undefined,gender:undefined,email:undefined};return b},getProfileData:function(){var a=this;a.oauth=OAuth(a.getAccessTokenParams());a.oauth.get(a.getProfileDataLink(),function(b){b=b.text;b=JSON.parse(b);b.error?a.onError("token error"):a.onProfileData(a.formatProfileData(b))},function(b){a.onError("token error")})},sendPost:function(a,d,c,e){var b=this;b.oauth=OAuth(b.getAccessTokenParams());b.oauth.post("https://api.twitter.com/1/statuses/update.json",{status:a+" via @afishache "+d},function(f){f=f.text;e.call(c,"ok")},function(f){e.call(c,"error")})},onToken:function(d,a){var c=this;if(!a){c.__proto__.onToken.call(c,d);return}for(var b in d){c[b]=d[b]}c.oauth.get(c.getAccessTokenLink(),function(e){e=e.text;e=e.getParamsFromUrl();e.error?c.onError("token error"):c.__proto__.onToken.call(c,e,true)},function(e){c.onError("token error")})},}],get:function(a){var b=this;return a!==undefined?b._list[a]:b._list},_init:function(){var b=this;for(var a=0;a<b._list.length;a++){b._list[a].__proto__=b._provider}return b}})._init();var Auth={login:function(e,c,d,a){var b=this;d=d||b.onSuccess;a=a||b.onError;c=c||b;Providers._provider.onSuccess=function(f){d.call(c,{provider:this,data:f})};Providers._provider.onError=function(){a.call(c,{provider:this,error:"unauthorized"})};if(typeof e=="number"){e=Providers.get(e)}e.authorize()},isAuthorized:function(b,c){var a=this;a.temp_index=Providers.get().length;Providers._provider.onSuccess=function(d){c.call(b,{provider:this,data:d})};Providers._provider.onError=function(){a.temp_index--;a.temp_index>-1?Providers.get(a.temp_index).authorize(true):c.call(b,{provider:this,error:"unauthorized"})};Providers._provider.onError();return false},logout:function(c){var b=Providers.get();for(var a=0;a<b.length;a++){b[a].logout()}},onError:function(a){},onSuccess:function(a){}};if(String.prototype.getParamsFromUrl===undefined){String.prototype.getParamsFromUrl=function(){var d=this,a=[],f={},c=[];var e=d.indexOf("#");e==-1?e=d.indexOf("?"):"";if(e==-1){e=d.indexOf("%");if(e==-1){a=d.slice(e+1).split("&")}else{a=d.slice(e+3).split("&")}}else{a=d.slice(e+1).split("&")}for(var b=0;b<a.length;b++){param=a[b].split("=");f[param[0]]=param[1]}return f}};