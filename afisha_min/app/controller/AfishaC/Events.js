var distanceSort=new Ext.util.Sorter({sorterFn:function(b,a){if(typeof b.data.lat!=="number"||typeof b.data.lng!=="number"||typeof a.data.lat!=="number"||typeof a.data.lng!=="number"){return 1}var d=Geo.dist(b.data.lat,b.data.lng,Afisha.position.coords.latitude,Afisha.position.coords.longitude);var c=Geo.dist(a.data.lat,a.data.lng,Afisha.position.coords.latitude,Afisha.position.coords.longitude);return d>c?1:(d<c?-1:0)}});Ext.define("Afisha.controller.AfishaC.Events",{extend:"Ext.app.Controller",config:{lastTabNum:0,categoryId:"",refs:{viewport:"aviewport",view:"events",toolbar:"events titlebar",tabpanel:"events tabpanel",eventsList:"events tabpanel #eventsList",placesList:"events tabpanel #placesList",filterButton:"events titlebar #filterButton",searchButton:"events titlebar #searchButton",sortButton:"events titlebar #sortButton",searchEdit:"events fieldset textfield",searchPanel:"events fieldset"},control:{view:{setFilter:"onSetFilter",sortBy:"onSortBy"},tabpanel:{activeitemchange:"onSwitch"},placesList:{itemtap:"onPlacesListItemTap"},eventsList:{itemtap:"onEventsListItemTap"},sortButton:{tap:"onSortButtonPress"},searchButton:{tap:"onSearchButtonPress"},filterButton:{tap:"onFilterButtonPress"}}},init:function(){this.control({searchEdit:{keyup:Ext.Function.createBuffered(this.onSearchKeyUp,400,this),clearicontap:"onSearchClear"}});Afisha.initListWidth()},initView:function(a){this.getEventsList().sortConfig={type:"filterAllDays",caption:"Выбрать за",fn:this.onFilterByDatePressed,getData:function(){return[{name:"Сегодня",value:"filterCurrentDay"},{name:"Завтра",value:"filterNextDay"},{name:"Текущую неделю",value:"filterCurrentWeek"},{name:"Следущую неделю",value:"filterNextWeek"},{name:"Все",value:"filterAllDays"}]}};this.getPlacesList().sortConfig={type:"alphabet",fn:this.onSortMenuItemPress,caption:"Сортировать по",getData:function(){return[{name:"Алфавиту",value:"alphabet"},{name:"Рейтингу",value:"rating"},{name:"Расстоянию",value:"distance",selectable:(Afisha.useGPS&&Afisha.position)}]}};this.setupDialog(a.name,a.eventsName,a.placesName,a.onlyPlaces,a.filter,a.id)},onFilterButtonPress:function(){var a=Ext.create("widget.filterview");a.show();a.fireEvent("construct",this.getCategoryId())},onSortBy:function(a){this.onSortMenuItemPress(a)},onSetFilter:function(a){this.resetScroll();this.getPlacesList().getStore().clearFilter(true);this.getPlacesList().getStore().filterBy(function(e){var d=true;for(var c in a){if(!d){return false}if(a[c]&&a[c]>0){var b=e.get(c);if(b instanceof Array){d=d&&(b.indexOf(a[c])>-1)}else{d=d&&(b==a[c])}}}return d})},onSwitch:function(){var a=this;setTimeout(function(){a.onSearchClear()},300);this.getSearchPanel().setHidden(true)},onSearchKeyUp:function(){var c=this.getSearchEdit().getValue();var a=this.getTabpanel().getActiveItem().getStore();if(c){var b="("+c.replace(/ /g,"|")+")";a.filter("name",new RegExp(b,"gi"))}else{a.clearFilter()}},onSearchClear:function(){this.getPlacesList().getStore().clearFilter();this.getEventsList().getStore().clearFilter();this.getSearchEdit().setValue("")},onSearchButtonPress:function(){var a=this.getSearchPanel().getHidden();if(!a){this.onSearchClear()}else{this.getSearchEdit().setValue("");var b=this;setTimeout(function(){b.getSearchEdit().focus()})}this.getSearchPanel().setHidden(!a)},resetScroll:function(){var b=this.getTabpanel().getActiveItem();var a=b.getScrollable().getScroller();a.scrollTo(0,0,false)},onFilterByDatePressed:function(d){this.getTabpanel().getActiveItem().sortConfig.type=d;var c=this.getTabpanel().getActiveItem();var a=c.getStore();this.resetScroll();var b=null;switch(d){case"filterCurrentDay":b=new Date();break;case"filterNextDay":b=new Date();b.nextDay();break;case"filterCurrentWeek":b="week";break;case"filterNextWeek":b="nextweek";break;default:a.clearFilter();return}a.clearFilter();a.filterBy(function(g){var j=Ext.getStore("Schedule");var i=g.data.id;var e;var f;var h;j.each(function(k){if(k.data.event_id==i){if(!e&&!h){e=h=k.data.start_date;f=k.data.start_time;return}if(k.data.start_date<=e&&k.data.start_time<f){e=k.data.start_date;f=k.data.start_time}if(k.data.start_date>h){h=k.data.start_date}}});return Afisha.schMethods.compareDates(b,e,h)&&f>=new Date().format("H:i")})},onSortMenuItemPress:function(b){this.getTabpanel().getActiveItem().sortConfig.type=b;var a=this.getTabpanel().getActiveItem().getStore();switch(b){case"alphabet":a.sort([{property:"sort",direction:"DESC"},quotesSort]);break;case"rating":a.sort([{property:"sort",direction:"DESC",},{property:"vote",direction:"ASC"}]);break;case"distance":a.sort([{property:"sort",direction:"DESC",},distanceSort])}},onSortButtonPress:function(){if(!this.sortpopup){this.sortpopup=Ext.create("widget.popuplist",{id:"sortpopup"})}var a=this.getTabpanel().getActiveItem();if(this.sortpopup.lastPanel!=a){this.sortpopup.setTitle(a.sortConfig.caption);this.sortpopup.setFn({Fn:a.sortConfig.fn,scope:this});this.sortpopup.setData(a.sortConfig.getData());this.sortpopup.lastPanel=a;this.sortpopup.select(a.sortConfig.type,false,true)}this.sortpopup.showBy(this.getSortButton())},onPlacesListItemTap:function(c,a,d,b){this.setLastTabNum(1);this.getApplication().fireEvent("showItem","placeview",b,true)},onEventsListItemTap:function(c,a,d,b){this.setLastTabNum(0);this.getApplication().fireEvent("showItem","eventview",b,true)},setupDialog:function(b,d,c,a,e,g){this.setCategoryId(g);var f=this.getTabpanel();this.getToolbar().setTitle(b);f.getTabBar().getAt(0).setTitle(d);f.getTabBar().getAt(1).setTitle(c);f.setActiveItem(a?1:0);f.getTabBar().setHidden(a);this.getPlacesList().getScrollable().getScroller().scrollTo(0,0,false);this.getEventsList().getScrollable().getScroller().scrollTo(0,0,false);this.getFilterButton().setHidden(e==null);this.getSortButton().setHidden(e!=null);this.onSearchClear();this.getSearchPanel().setHidden(true)},goBack:function(){this.resetScroll();if(this.sortpopup&&!this.sortpopup.getHidden()){this.sortpopup.hide();return true}if(!this.getSearchPanel().getHidden()){this.onSearchClear();this.getSearchPanel().setHidden(true);return true}var a=Ext.Viewport.down("filterview");if(a!=null){Ext.Viewport.remove(a);return true}return false},launch:function(){var b,a,c;a=this.getViewport().element;b=new Ext.Element(document.createElement("div"));b.setStyle("height","0em");b.setStyle("width","1em");a.appendChild(b);this.em=b.getWidth();Ext.XTemplate.addMember("em",this.em);Ext.XTemplate.addMember("eventListImgSize",Math.ceil(this.em*4.3));Ext.XTemplate.addMember("newsListImgSize",Math.ceil(this.em*3));a.removeChild(b)}});