Ext.define("Afisha.controller.AfishaC.OAuth",{extend:"Ext.app.Controller",hideAuthView:function(){if(this.userdata){this.onAuthCallback&&this.onAuthCallback(this.userdata);this.authView.hide()}},onButtonTap:function(b,a){this.callback={that:this,callback:this.hideAuthView};this.login(a)},getUserData:function(a){if(!this.userdata){this.onAuthCallback=a;this.showAuthView()}else{a(this.userdata)}},showAuthView:function(){if(!this.authView){this.authView=Ext.create("Afisha.view.AuthView",{controller:this});Ext.Viewport.add(this.authView)}this.authView.show()},isAuthorized:function(a,b){this.callback={that:a,callback:b};if(Ext.os.deviceType==="Desktop"){this.userdata=false;this.callback.callback.call(this.callback.that);return}Auth.isAuthorized(this,this.onResult)},userdata:undefined,onResult:function(a){this.userdata=a.error?false:a.data;if(Ext.os.deviceType==="Desktop"){this.prov_image="config/resources/icons/social/iko_6.png"}else{this.prov_image=a.provider.icon}this.callback.callback.call(this.callback.that)},unAuthorize:function(a){this.userdata=a?undefined:false;this.callback.callback.call(this.callback.that);Auth.logout()},login:function(a){this.unAuthorize(1);if(Ext.os.deviceType==="Desktop"){this.onResult({data:{identity:"http://yandex.ru",full_name:"Антон Перякин"}});return}Auth.login(a,this,this.onResult,this.onResult)},post:function(a,e,d,c,f){var b=this;if(!this.userdata||this.userdata.prov_name!==Providers.get(a).name){this.unAuthorize(1);Auth.login(a,this,function(g){b.userdata=g.error?false:g.data;if(Ext.os.deviceType==="Desktop"){this.prov_image="config/resources/icons/social/iko_6.png"}else{b.prov_image=g.provider.icon}b.post(a,e,d,c,f)},function(g){b.userdata=g.error?false:g.data;if(Ext.os.deviceType==="Desktop"){this.prov_image="config/resources/icons/social/iko_6.png"}else{b.prov_image=g.provider.icon}f.call(c,"error")})}else{Providers.get(a).sendPost(e,d,c,f);Ext.Msg.alert(G.app_name,"Сообщение отправлено.")}}});