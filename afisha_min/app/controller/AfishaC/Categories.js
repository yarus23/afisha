var quotesSort=new Ext.util.Sorter({direction:"ASC",sorterFn:function(b,a){function c(d){if(d.length&&(d[0]==='"'||d[0]==="'"||d.charCodeAt(0)===171)){return d.replace(/['"\u00BB\u00AB]/g,"").toLowerCase()}else{return d.toLowerCase()}}if(!b.data||!a.data){return 0}s1=c(b.data.name);s2=c(a.data.name);if(s1===s2){return 0}return s1<s2?-1:1}});Ext.define("Afisha.controller.AfishaC.Categories",{extend:"Ext.app.Controller",defaultStore:"Categories",defaultTitle:Global.app_name,currentSubStore:null,config:{refs:{viewport:"aviewport",categoriesView:"aviewport categories",topToolbar:"aviewport categories toptoolbar",catList:"aviewport categories list"},control:{viewport:{orientationchange:"onOrientationchange"},catList:{itemtap:"onCatListItemTap"}}},onOrientationchange:function(){Afisha.initListWidth()},launch:function(){this.getApplication().on({switchToEvents:this.switchToEvents,switchTo:this.switchTo,switchToPlaceView:this.switchToPlaceView,scope:this})},switchTo:function(b){var a=this;this.loadCategory(b,function(){a.showEventsDialog(b)})},switchToEvents:function(){this.switchTo(this.selectedItem.get("id"))},switchToPlaceView:function(a){this.loadCategory(a.type,function(){var d=Ext.getStore("Places");var c=d.getById(a.rid);if(c==null){var b=Ext.getStore("Favorites");b.setFav(a);Afisha.gf.alert("Место больше недоступно и будет удалено из избранного!");return}Afisha.app.getApplication().fireEvent("showItem","placeview",c,true)})},showEventsDialog:function(e){var a=Ext.getStore(this.defaultStore);var c=Ext.getStore("LifeSubCategories");var f=a.find("id",e);var d=c.find("id",e);if(d>=0){var b=c.getAt(d);this.getApplication().fireEvent("showItem","events",{name:b.get("name"),eventsName:b.get("left")?b.get("left").name:"",placesName:b.get("right").name,onlyPlaces:b.get("hiddenToolbar"),filter:b.get("filter"),id:e})}else{if(f<0){alert("Нет такой категории")}else{var b=a.getAt(f);this.getApplication().fireEvent("showItem","events",{name:b.get("name"),eventsName:b.get("left")?b.get("left").name:"",placesName:b.get("right").name,onlyPlaces:b.get("hiddenToolbar"),filter:b.get("filter"),id:e})}}},onCatListItemTap:function(d,a,e,b){this.selectedItem=b;var c=b.get("subcategories");if(c){this.getTopToolbar().setTitle(b.get("name"));this.getCatList().setStore(c);this.currentSubStore=c;return}var d=this;this.loadCategory(b.get("type"),function(){d.showEventsDialog(b.get("id"))})},reInitCategoryList:function(){this.getCatList().setStore(this.defaultStore);this.getTopToolbar().setTitle(this.defaultTitle);this.currentSubStore=null},goBack:function(){if(this.currentSubStore){this.reInitCategoryList();return true}return false},loadJsonP:function(a,b){Ext.data.JsonP.request({url:Global.server_url,params:{type:a},callbackKey:"callback",scope:this,callback:b})},loadCategory:function(c,e){var f;var h=function(j,i){if(j){var k=Ext.encode(i.root);if(g){g.set("data",k);g.set("timestamp",Ext.Date.now());g.set("hash",f)}else{a.add({name:c,data:k,timestamp:Ext.Date.now()})}a.sync();this.fillStores(k,c,e)}else{if(g){Afisha.gf.alert("Проверьте интернет соединение. Данные могут быть неактуальными.");this.fillStores(g.get("data"),c,e)}else{Afisha.gf.alert("Не удалось загрузить данные. Проверьте интернет соединение.");console.log("Не удалось загрузить данные")}}Ext.Viewport.setMasked(false)};var a=Ext.getStore("Cache");if(!this.cacheLoaded){a.load();this.cacheLoaded=true}var g=a.findRecord("name",c);var d=this;function b(){if(g&&(g.get("hash")==f)){console.log("loading "+c+" from cache");d.fillStores(g.get("data"),c,e);g.set("timestamp",Ext.Date.now())}else{Ext.Viewport.setMasked({xtype:"loadmask",message:"Загрузка данных..."});d.loadJsonP(c,h)}}if(g&&((Ext.Date.now()-g.get("timestamp"))<(1000*60*10))){console.log("loading "+c+" from memory");if(this.currentCategory==c){e()}else{this.fillStores(g.get("data"),c,e)}}else{Ext.data.JsonP.request({url:Global.server_url,params:{type:c,mode:"hash"},callbackKey:"callback",scope:this,callback:function(j,i){if(j){f=i.hash;b()}else{Ext.Viewport.setMasked({xtype:"loadmask",message:"Загрузка данных..."});d.loadJsonP(c,h)}}})}},fillStores:function(e,f,k){var c=Ext.decode(e);var d=Ext.getStore("Schedule");var j=Ext.getStore("Places");var h=Ext.getStore("Events");var a=Ext.getStore("Dictionary");if(!d||!j||!h){console.log("Ошибка загрузки store!");return false}d.clearData();j.clearData();h.clearData();for(var b in c){switch(b){case"schedule":d.setData(Afisha.gf.unifySchedule(c[b]));d.setCurrentType(f);break;case"films":case"events":h.setData(c[b]);h.setCurrentType(f);break;case"places":j.setData(c[b]);j.setCurrentType(f);j.sort([{property:"sort",direction:"DESC"},quotesSort]);break;default:var g=a.find("id",b);c[b][0]="Не выбрано";if(g==-1){a.add({id:b,data:c[b]})}break}}console.log("loaded schedule "+d.getCount());console.log("loaded places "+j.getCount());console.log("loaded events "+h.getCount());console.log("loaded dictionaries "+a.getCount());this.currentCategory=f;k();return true}});