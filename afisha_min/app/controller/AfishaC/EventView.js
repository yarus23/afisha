Ext.define("Afisha.controller.AfishaC.EventView",{extend:"Ext.app.Controller",config:{currentType:"",currentRecord:null,refs:{viewport:"aviewport",selectfield:"aviewport eventview toolbar selectfield",title:"aviewport eventview panel#ev_header panel#ev_title",genre:"aviewport eventview panel#ev_genre",rateCount:"aviewport eventview panel#ev_header panel#ev_rate_count",rateImg:"aviewport eventview panel#ev_header img",buttons:"aviewport eventview panel#ev_buttons",photogallery:"aviewport eventview photogallery",schList:"aviewport eventview schedulelist",footer:"aviewport eventview panel#ev_footer"},control:{selectfield:{change:"onSelectChange"},eventview:{show:"onEVShowTimeOut"}}},onSelectChange:function(d,c,a){var b;switch(c){case 0:b=new Date();break;case 1:b=new Date();b.nextDay();break;case"full":b=null;break;default:b=c;break}this.getSchList().bindScheduleData(this.getCurrentRecord().get("id"),b,true);this.onEVShow()},onEVShowTimeOut:function(){var a=this;setTimeout(function(){a.onEVShow()},200)},onEVShow:function(){var e=this.getSchList();var b=e.element.query(".scheduleItem");var a=0;if(b.length==0||e.onlyHeader){var f=e.element.down(".x-list-header");if(f){e.setHeight(f.getHeight())}}else{for(var d=0;d<b.length;d++){var c=b[d].style["-webkit-transform"];if((b[d].textContent.trim()!="")&&(!c||(c&&c.indexOf("-10000px")==-1))){a+=b[d].offsetHeight}}e.setHeight(a)}e.removeCls("getsize")},initView:function(b){var f=Ext.getStore("Places").getCurrentType();this.setCurrentType(f);this.setCurrentRecord(b);var c;var e;var d=Ext.getStore("Categories");var a=d.getById(f);if(!a){d.findBy(function(i){var h=i.get("subcategories");if(!h){return false}var g=Ext.getStore(h).getById(f);if(g){c=g.get("options");e=g.get("filter")}else{return false}})}else{c=a.get("options");e=a.get("filter")}this.setSelectConfig(b,c);this.setupHeader(b);this.collectImages(b);b.set("type",f);this.getFooter().setRecord(b)},setSelectConfig:function(b,c){var a=this.getSelectfield();var e=this.getSchList();if(!c||c.schType=="none"){a.hide();e.hide();return}else{e.show()}var d=0;if(c.schType=="service"){this.getSchList().bindScheduleData(b.get("id"),null,true);d=1}else{if(c.schSelectDefType==null){d=this.getSchList().bindScheduleData(b.get("id"),null,true);a.setValue("full")}else{if(c.schSelectDefType=="week"){d=this.getSchList().bindScheduleData(b.get("id"),"week",true);a.setValue("week")}else{d=this.getSchList().bindScheduleData(b.get("id"),new Date(),true);a.setValue(0)}}}if(d<2){a.hide()}else{a.show()}},setupHeader:function(c){var d=c.get("name");this.getTitle().setHtml(d?d:c.get("aka"));var f=parseFloat(c.get("vote"));if(isNaN(f)){f=0}f=Math.floor(f+0.499);this.getRateImg().setSrc("resources/star-"+f+".png");this.getRateCount().setHtml(c.get("num_votes"));var b=this.getGenre();b.setHtml("");var a=c.get("genre");var g=c.get("runtime");var e=a?a:"";e+=g?(" ("+g+" мин.)"):"";b.setHtml(e)},checkButtonsFields:function(a){var b=this.getButtons();b.removeAll();b.add({id:"ev_commentsBtn",xtype:"clickbutton",style:"border-top:0;",data:{value:"Добавить/Читать отзывы ("+a.get("com_count")+")"}})},collectImages:function(b){var g=[];var e=Global.img_url;var d=b.get("poster");if(d&&(d.image instanceof Array)&&d.length){for(var a=0;a<d.length;a++){if(d[a].json){g.push(e+d[a].json[0])}else{g.push(e+d[a][0])}}}else{for(var c=0;c<d.length;c++){g.push(e+d[c][0])}}var f=this.getPhotogallery();f.loadPictureList(g)},goBack:function(){return false}});