Ext.define("Afisha.controller.Discount.DiscList",{extend:"Ext.app.Controller",config:{refs:{viewport:"aviewport",discList:"disclist #disclist",sb:"disclist segmentedbutton#disc_catlist",},control:{discList:{itemtap:"onListItemTap"},sb:{toggle:"changeCategory"}}},addCategories:function(a){var b=this.getSb();b.add({rub_id:a.get("id"),text:a.get("name")});b.show()},initView:function(b){var a=this.getDiscList().getStore();if(!a.isLoaded()&&!a.isLoading()){this.getDiscList().setMasked({xtype:"loadmask",message:"Загрузка"});this.getDiscList().setLoadingText(" ");a.currentPage=1;a.load(this.changeCategoryComplete,this)}var c=Ext.getStore("DiscRubric");if(!c.data||!c.data.items||c.data.items.length==0){c.load({callback:function(e,d,g){if(!g){return}for(var f=0;f<e.length;f++){this.addCategories(e[f])}},scope:this})}},onStoreLoadFail:function(a){if(!a){a="Не могу загрузить данные"}Afisha.gf.alert(a)},launch:function(){var b,a,c;a=this.getViewport().element;b=new Ext.Element(document.createElement("div"));b.setStyle("height","0em");b.setStyle("width","1em");a.appendChild(b);this.em=b.getWidth();c=Math.ceil(a.getWidth()-this.em*1.5);Ext.XTemplate.addMember("em",this.em);Ext.XTemplate.addMember("listImgSize",Math.ceil(this.em*4.3));Ext.XTemplate.addMember("bodyWidth",c<=1000?c:1000);a.removeChild(b)},changeCategory:function(d,c,a,f){Afisha.gf.isOnline(true);var b=this.getDiscList().getStore();b.getProxy().setExtraParam("rubric_id",c.config.rub_id);this.getDiscList().setLoadingText(" ");b.currentPage=1;b.load(this.changeCategoryComplete,this)},changeCategoryComplete:function(){this.getDiscList().setLoadingText(null)},onListItemTap:function(g,e,h,b){var d,f,c,a;if(!Afisha.gf.isOnline(true)){return}d=b.get("id");this.getApplication().fireEvent("showItem","discview",{rec_id:d})}});