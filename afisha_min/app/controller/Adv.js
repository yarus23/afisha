Ext.define("Afisha.controller.Adv",{extend:"Ext.app.Controller",config:{refs:{advPanel:"adv",advImg:"adv img",as:"actionsheet#advAS"},control:{advImg:{load:"onImgLoad",tap:"onImgTap"}}},launch:function(){this.loadAdv()},onImgLoad:function(){this.getAdvPanel().show()},onImgTap:function(c){var a=this.getAs();if(a.items.items.length>2){a.show()}else{var b=c.element.query("a");if(b&&b.length){MT.gf.openUrl(b[0],undefined,Ext.os.is.iOS)}}},loadAdv:function(){var a=Ext.Ajax.request({url:Global.adv,method:"POST",scope:this,success:function(b,d){var c,e;this.loaded=true;c=b.responseXML;if(!c){return}e=xml2obj(c);if(!e&&!this.getAdvPanel().isHidden()){this.getAdvPanel().hide();return}this.bindData(e)},failure:function(b,c){this.loaded=false}})},bindData:function(e){var a=this.getAs(),c=this.getAdvPanel(),d=this.getAdvImg();if(!e){return}this.data=e;this.data.adTypeSlim?c.setHeight(window.innerWidth*40/640):c.setHeight(window.innerWidth*90/640);d.setSrc(e.AdImage);d.setData({AdClickURL:e.AdClickURL});a.removeAll();if(e.Button&&e.Button instanceof Array){if(e.adHeader){this.addASButton({xtype:"panel",html:e.adHeader,styleHtmlCls:"actionSheetHeaderHtml",cls:"actionSheetHeader"})}else{this.addASButton({xtype:"panel",html:"",style:"display:none;"})}for(var b=0;b<e.Button.length;b++){if(this.isParams(e.Button[b])){this.addASButton(e.Button[b])}}this.addASButton({text:"Отмена",action:"cancel",params:null,ui:"decline"})}},isParams:function(a){if(!a.action){return false}switch(a.action){case"call":return !!a.params;case"email":return !!a.params&&!!a.params.to;case"site":return !!a.params;case"map":return !!a.params&&!!a.params.latitude&&!!a.params.longitude;default:return false}},addASButton:function(c){var b={};for(var d in c){b[d]=c[d]}b.handler=this.onADButtonClick;b.scope=this;if(c.action=="call"){delete b.text;b.style="padding: 0em;";b.handler=null;b.html='<a class="x-button-label" style="color:black; text-decoration: none; padding: .3em .6em;" href="tel:'+c.params+'">'+c.text+"</a>"}else{if(c.action=="email"&&c.params){delete b.text;b.style="padding: 0em;";b.handler=null;var a="mailto:";if(c.params.to){a+=c.params.to}if(c.params.subject){a+="?subject="+c.params.subject}if(c.params.body){a+="&body="+c.params.body}b.html='<a class="x-button-label" style="color:black; text-decoration: none; padding: .3em .6em;" href="'+a+'">'+c.text+"</a>"}}this.getAs().add(b)},adClickMap:{cancel:function(){this.getAs().hide()},site:function(a){var b=document.createElement("a");b.setAttribute("href",a);Afisha.gf.openUrl(b,undefined,Ext.os.is.iOS);this.getAs().hide()},map:function(a){this.getAs().hide();Afisha.app.fireEvent("showItem","mapview",a)}},onADButtonClick:function(a,b){if(a.config.action&&this.adClickMap[a.config.action]){this.adClickMap[a.config.action].call(this,a.config.params)}},goBack:function(){var a=this.getAs();if(!a.isHidden()){a.hide();return true}return false}});