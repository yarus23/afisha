Ext.define("Afisha.controller.News.NewsList",{extend:"Ext.app.Controller",config:{refs:{viewport:"aviewport",newsList:"#newslist",sb:"segmentedbutton#catlist",},control:{newsList:{itemtap:"onListItemTap"},sb:{toggle:"changeCategory"},}},addCategories:function(a){var b=this.getSb();b.add({rub_id:a.get("id"),text:a.get("name")});b.show()},initView:function(b){var a=this.getNewsList().getStore();if(!a.isLoaded()&&!a.isLoading()){this.getNewsList().setMasked({xtype:"loadmask",message:"Загрузка"});this.getNewsList().setLoadingText(" ");a.currentPage=1;a.load(this.changeCategoryComplete,this)}var c=Ext.getStore("NewsRubric");if(!c.data||!c.data.items||c.data.items.length==0){c.load({callback:function(e,d,g){if(!g){return}for(var f=0;f<e.length;f++){this.addCategories(e[f])}},scope:this})}},addToFavorites:function(){var c,e,b,f,a,d;c=this.getBody().getBodyOptions();if(!c||c.reInit){return}e=this.getFavoritesList().getStore();b=e.getModel();a=this.checkFavorites(c.record.get("rid"),e);if(a!=-1){e.removeAt(a);e.sync();this.setEnabledFavoritesIcon(false);return}delete c.record.data.id;f=new b(c.record.data);e.add(f);e.sync();this.setEnabledFavoritesIcon(true);News.gf.alert("Статья добавлена в избранное! Чтобы удалить ее из избранного нажмите на звездочку еще раз.")},checkFavorites:function(a,b){if(!b){b=this.getFavoritesList().getStore()}return b.find("rid",a)},setEnabledFavoritesIcon:function(a){var b=this.getFavButton().element.down("span.x-button-icon.x-icon-mask");if(!b){return}if(a){b.addCls("gold")}else{b.removeCls("gold")}},onStoreLoadFail:function(a){if(!a){a="Не могу загрузить данные"}News.gf.alert(a)},launch:function(){var b=this.getNewsList().getStore();var c,a,d;a=this.getViewport().element;c=new Ext.Element(document.createElement("div"));c.setStyle("height","0em");c.setStyle("width","1em");a.appendChild(c);this.em=c.getWidth();d=Math.ceil(a.getWidth()-this.em*1.5);Ext.XTemplate.addMember("em",this.em);Ext.XTemplate.addMember("listImgSize",Math.ceil(this.em*4.3));Ext.XTemplate.addMember("bodyWidth",d<=1000?d:1000);a.removeChild(c)},changeCategory:function(d,c,a,f){Afisha.gf.isOnline(true);var b=this.getNewsList().getStore();b.getProxy().setExtraParam("rubric_id",c.config.rub_id);this.getNewsList().setLoadingText(" ");b.currentPage=1;b.load(this.changeCategoryComplete,this)},changeCategoryComplete:function(){this.getNewsList().setLoadingText(null)},onListItemTap:function(g,e,h,b){var d,f,c,a;if(!Afisha.gf.isOnline(true)){return}d=b.get("id");this.getApplication().fireEvent("showItem","pageview",{rec_id:d})}});