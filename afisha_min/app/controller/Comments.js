Ext.define("Afisha.controller.Comments",{extend:"Ext.app.Controller",config:{objectParams:{},userData:null,refs:{list:"commentsview dataview",addBtn:"commentsview button#addComment",modal:"commentsview #sendCommentModal",textarea:"commentsview textareafield",okButton:"commentsview #sendCommentOk",cancelButton:"commentsview #sendCommentCancel",authview:"authview",},control:{addBtn:{tap:"onAddCommentBtnTap"},okButton:{tap:"onOkButtonClick"},cancelButton:{tap:"onCancelButtonClick"}}},initView:function(c){this.setObjectParams(c);var d=this.getList();var a=d.getStore();a.setData([]);d.setMasked({xtype:"loadmask",message:"Загрузка"});var b=a.getProxy();b.setExtraParam("elem_type",c.elem_type);b.setExtraParam("type",c.type);b.setExtraParam("elem_id",c.elem_id);a.load(function(f,e,g){if(!g){Afisha.gf.alert("Ошибка загрузки комментариев!")}},this)},onAddCommentBtnTap:function(){var a=this.getUserData();if(!a){this.userLogin();return}this.getModal().show()},userLogin:function(){var b=this;var a=Afisha.app.getController("AfishaC.OAuth"),c=function(d){if(!d){Afisha.gf.alert("Ошибка авторизации");return}b.setUserData(d);b.getModal().show()};a.getUserData(c)},sendComment:function(d){var b=this;var c=this.getObjectParams();var a=this.getUserData();if(!a){Afisha.gh.alert("Необходимо авторизоваться перед отправкой комментария!");return}c.vote=0;c.body=d;c.sign=0;c.user_data=a;Ext.Ajax.request({url:"http://mobile.afisha-uu.ru/app/ulanude/comments",method:"POST",timeout:10000,jsonData:c,callback:function(f,g,e){if(g){Afisha.gf.alert("Комментарий успешно отправлен!");b.getModal().hide();b.getList().getStore().load();return}else{Afisha.gf.alert("Произошла ошибка при отправек комментария.")}}})},onCancelButtonClick:function(){this.getTextarea().setValue("");this.getModal().hide()},onOkButtonClick:function(){var a=this.getTextarea().getValue();if(a.length==0){Afisha.gf.alert("Введите текст комментария!");return}this.sendComment(a)},goBack:function(){var b=this.getAuthview();if(b&&!b.isHidden()){b.hide();return true}var a=this.getModal();if(a&&!a.isHidden()){a.hide();return true}return false}});